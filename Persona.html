<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2015-02-23 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20150223" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Yoke micro-framework - Yoke</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.1.min.js"></script>

    
                  </head>
        <body class="topBarEnabled">
          
    
    
            
    
        
    <a href="http://github.com/apache/maven-skins">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
        alt="Fork me on GitHub">
    </a>
  
                        
                    
                

    <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
                                  <div class="container" style="width: 90%;"><div class="nav-collapse">
            
                
                                                                                <a class="brand" href="index.html" >

                                
                                    Yoke
                
                </a>
                    
                                <ul class="nav">
                          <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Middleware <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="middleware/basic-auth.html"  title="Basic Auth">Basic Auth</a>
</li>
                  
                      <li>      <a href="middleware/body-parser.html"  title="Body Parser">Body Parser</a>
</li>
                  
                      <li>      <a href="middleware/bridge-secure-handler.html"  title="Bridge Secure Handler">Bridge Secure Handler</a>
</li>
                  
                      <li>      <a href="middleware/compress.html"  title="Compress">Compress</a>
</li>
                  
                      <li>      <a href="middleware/cookie-parser.html"  title="Cookie Parser">Cookie Parser</a>
</li>
                  
                      <li>      <a href="middleware/cors.html"  title="CORS">CORS</a>
</li>
                  
                      <li>      <a href="middleware/csrf.html"  title="CSRF">CSRF</a>
</li>
                  
                      <li>      <a href="middleware/error-handler.html"  title="Error Handler">Error Handler</a>
</li>
                  
                      <li>      <a href="middleware/favicon.html"  title="Favicon">Favicon</a>
</li>
                  
                      <li>      <a href="middleware/form-auth.html"  title="Form Auth">Form Auth</a>
</li>
                  
                      <li>      <a href="middleware/jwt.html"  title="JWT">JWT</a>
</li>
                  
                      <li>      <a href="middleware/limit.html"  title="Limit">Limit</a>
</li>
                  
                      <li>      <a href="middleware/logger.html"  title="Logger">Logger</a>
</li>
                  
                      <li>      <a href="middleware/method-override.html"  title="Method Override">Method Override</a>
</li>
                  
                      <li>      <a href="middleware/request-proxy.html"  title="Request Proxy">Request Proxy</a>
</li>
                  
                      <li>      <a href="middleware/response-headers.html"  title="Response Headers">Response Headers</a>
</li>
                  
                      <li>      <a href="middleware/router.html"  title="Router">Router</a>
</li>
                  
                      <li>      <a href="middleware/session.html"  title="Session">Session</a>
</li>
                  
                      <li>      <a href="middleware/static.html"  title="Static">Static</a>
</li>
                  
                      <li>      <a href="middleware/timeout.html"  title="Timeout">Timeout</a>
</li>
                  
                      <li>      <a href="middleware/vhost.html"  title="VHost">VHost</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorial <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="tutorial/java.html"  title="Java">Java</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li class="dropdown-submenu">
                                      <a href="project-info.html"  title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="dependencies.html"  title="Dependencies">Dependencies</a>
</li>
                                  <li>      <a href="team-list.html"  title="Project Team">Project Team</a>
</li>
                                  <li>      <a href="integration.html"  title="Continuous Integration">Continuous Integration</a>
</li>
                                  <li>      <a href="issue-tracking.html"  title="Issue Tracking">Issue Tracking</a>
</li>
                                  <li>      <a href="license.html"  title="Project License">Project License</a>
</li>
                                  <li>      <a href="source-repository.html"  title="Source Repository">Source Repository</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="project-reports.html"  title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="apidocs/index.html"  title="JavaDocs">JavaDocs</a>
</li>
                                  <li>      <a href="testapidocs/index.html"  title="Test JavaDocs">Test JavaDocs</a>
</li>
                                  <li>      <a href="cobertura/index.html"  title="Cobertura Test Coverage">Cobertura Test Coverage</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                  </ul>
          
          
                                                                            
                   
                      </div>
          
        </div>
      </div>
    </div>
    
        <div class="container">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Yoke micro-framework</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2015-02-23
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 2.0.13
                      </li>
                      
                
                    
      
                            </ul>
      </div>

      
                
        <div id="bodyColumn" >
                                  
            <h1><a href="/">Yoke</a></h1>
<div class="section">
<h2>Mozilla Persona<a name="Mozilla_Persona"></a></h2>
<p><i>Persona allows you to sign in to sites using an email address you choose. So, instead of having to manage multiple usernames and passwords across your favorite sites and devices, you&#x2019;ll have more time to do the important stuff. Mozilla Will manage the details!</i></p>
<p>Adding the Persona login system to your site takes just five steps:</p>

<ul>
  
<li>Include the Persona JavaScript library on your pages.</li>
  
<li>Add &#x201c;login&#x201d; and &#x201c;logout&#x201d; buttons.</li>
  
<li>Watch for login and logout actions.</li>
  
<li>Verify the user&#x2019;s credentials.</li>
  
<li>Review best practices.</li>
</ul>
<p>This is the description available on the Mozilla website, and indeed it is quite simple to add Persona authentication to a application built on Yoke and <a class="externalLink" href="http://vertx.io">Vert.x</a></p></div>
<div class="section">
<h2>Include Persona JS library<a name="Include_Persona_JS_library"></a></h2>

<div class="source">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;${title}&lt;/title&gt;
  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=Edge&quot;&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;/css/persona-buttons.css&quot; /&gt;
  &lt;script src=&quot;//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js&quot;&gt;&lt;/script&gt;
  &lt;script src=&quot;https://login.persona.org/include.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
<p>This was very simple. Just save this in the resources directory and later we will use the <a href="Static.html">Static</a> middleware to serve it in parallel with the String placeholder engine.</p></div>
<div class="section">
<h2>Add login/logout buttons<a name="Add_loginlogout_buttons"></a></h2>

<div class="source">
<pre>&lt;body&gt;
  &lt;ul&gt;
      &lt;li&gt;&lt;a id=&quot;signin&quot; href=&quot;#&quot; class=&quot;persona-button&quot;&gt;&lt;span&gt;Sign in with your Email&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a id=&quot;signout&quot; href=&quot;#&quot;&gt;Log out&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
  Current User: ${email}
&lt;/body&gt;
&lt;script&gt;
  var signinLink = document.getElementById('signin');
  if (signinLink) {
    signinLink.onclick = function() { navigator.id.request(); };
  }

  var signoutLink = document.getElementById('signout');
  if (signoutLink) {
    signoutLink.onclick = function() { navigator.id.logout(); };
  }
&lt;/script&gt;
&lt;/html&gt;
</pre></div>
<p>Again piece of cake!</p></div>
<div class="section">
<h2>Watch for login and logout actions<a name="Watch_for_login_and_logout_actions"></a></h2>

<div class="source">
<pre>var currentUser = ${email};

  navigator.id.watch({
    loggedInUser: currentUser,
    onlogin: function(assertion) {
      $.ajax({
        type: 'POST',
        url: '/auth/login',
        data: {assertion: assertion},
        success: function(res, status, xhr) { window.location.reload(); },
        error: function(xhr, status, err) {
          navigator.id.logout();
          alert(&quot;Login failure: &quot; + err);
        }
      });
    },
    onlogout: function() {
      $.ajax({
        type: 'POST',
        url: '/auth/logout',
        success: function(res, status, xhr) { window.location.reload(); },
        error: function(xhr, status, err) { alert(&quot;Logout failure: &quot; + err); }
      });
    }
  });
</pre></div>
<p>Really?</p></div>
<div class="section">
<h2>Verify the user&#x2019;s credentials<a name="Verify_the_users_credentials"></a></h2>
<p>At this moment we enter the server side, so we need to implement a <a href="Static.html">Static</a> middleware to serve html, javascript and css files. After that we need to render the right html, since this example is so simple the string placeholder is perfect. and later we need to manage the session for the user and the API entry points:</p>

<ul>
  
<li><i>/</i> main page</li>
  
<li><i>/auth/login</i> login end-point</li>
  
<li><i>/auth/logout</i> logout end-point</li>
</ul>

<div class="source">
<pre>public class Persona extends Verticle {

  // This is an example only use a proper persistent storage
  Map&lt;String, String&gt; storage = new HashMap&lt;&gt;();

  @Override
  public void start() {
    final Yoke yoke = new Yoke(vertx);
    yoke.engine(&quot;html&quot;, new StringPlaceholderEngine());

    Mac secret = Utils.newHmacSHA256(&quot;secret here&quot;);

    // all environments
    yoke.use(new CookieParser(secret));
    yoke.use(new Session(secret));
    yoke.use(new BodyParser());
    yoke.use(new Static(&quot;static&quot;));
    yoke.use(new ErrorHandler(true));

    // routes
    yoke.use(new Router()
      .get(&quot;/&quot;, new Middleware() {
          @Override
          public void handle(final YokeRequest request, final Handler&lt;Object&gt; next) {
          String sid = request.getSessionId();
          String email = storage.get(sid == null ? &quot;&quot; : sid);

          if (email == null) {
            request.put(&quot;email&quot;, &quot;null&quot;);
          } else {
            request.put(&quot;email&quot;, &quot;'&quot; + email + &quot;'&quot;);
          }
          request.response().render(&quot;views/index.html&quot;, next);
          }
      })
      .post(&quot;/auth/logout&quot;, new Middleware() {
          @Override
          public void handle(YokeRequest request, Handler&lt;Object&gt; next) {
          // remove session from storage
          String sid = request.getSessionId();
          storage.remove(sid == null ? &quot;&quot; : sid);
          // destroy session
          request.setSessionId(null);
          // send OK
          request.response().end(new JsonObject().putBoolean(&quot;success&quot;, true));
          }
      })
      .post(&quot;/auth/login&quot;, new Middleware() {
          @Override
          public void handle(final YokeRequest request, final Handler&lt;Object&gt; next) {
          String data;

          try {
            // generate the data
            data = &quot;assertion=&quot; + URLEncoder.encode(request.formAttributes().get(&quot;assertion&quot;), &quot;UTF-8&quot;) +
                &quot;&amp;audience=&quot; + URLEncoder.encode(&quot;http://localhost:8080&quot;, &quot;UTF-8&quot;);
          } catch (UnsupportedEncodingException e) {
            next.handle(e);
            return;
          }

          HttpClient client = getVertx().createHttpClient().setSSL(true).setHost(&quot;verifier.login.persona.org&quot;).setPort(443);

          HttpClientRequest clientRequest = client.post(&quot;/verify&quot;, new Handler&lt;HttpClientResponse&gt;() {
            public void handle(HttpClientResponse response) {
              // error handler
              response.exceptionHandler(new Handler&lt;Throwable&gt;() {
                @Override
                public void handle(Throwable err) {
                  next.handle(err);
                }
              });

              final Buffer body = new Buffer(0);

              // body handler
              response.dataHandler(new Handler&lt;Buffer&gt;() {
                @Override
                public void handle(Buffer buffer) {
                  body.appendBuffer(buffer);
                }
              });
              // done
              response.endHandler(new Handler&lt;Void&gt;() {
                @Override
                public void handle(Void event) {
                  try {
                    JsonObject verifierResp = new JsonObject(body.toString());
                    boolean valid = &quot;okay&quot;.equals(verifierResp.getString(&quot;status&quot;));
                    String email = valid ? verifierResp.getString(&quot;email&quot;) : null;
                    if (valid) {
                      // assertion is valid:
                      // generate a session Id
                      String sid = UUID.randomUUID().toString();

                      request.setSessionId(sid);
                      // save it and associate to the email address
                      storage.put(sid, email);
                      // OK response
                      request.response().end(new JsonObject().putBoolean(&quot;success&quot;, true));
                    } else {
                      request.response().end(new JsonObject().putBoolean(&quot;success&quot;, false));
                    }
                  } catch (DecodeException ex) {
                    // bogus response from verifier!
                    request.response().end(new JsonObject().putBoolean(&quot;success&quot;, false));
                  }
                }
              });
            }
          });

          clientRequest.putHeader(&quot;content-type&quot;, &quot;application/x-www-form-urlencoded&quot;);
          clientRequest.putHeader(&quot;content-length&quot;, Integer.toString(data.length()));
          clientRequest.end(data);
          }
      })
    );

    yoke.listen(8080);
    container.logger().info(&quot;Yoke server listening on port 8080&quot;);
  }
}
</pre></div>
<p>There you go, less than 120 lines and you have a secure site!</p></div>
<div class="section">
<h2>Source code<a name="Source_code"></a></h2>
<p>For the full source code and project files all is available in <a class="externalLink" href="https://github.com/pmlopes/yoke/blob/master/example/persona">github</a>.</p></div>
<div class="section">
<h2>Notes<a name="Notes"></a></h2>
<p>The application is quite simple and of course the map in memory is not a valid or proper storage engine. With vert.x is quite simple to integrate data storages such as:</p>

<ul>
  
<li>mongoDB</li>
  
<li>redis</li>
  
<li>mysql</li>
</ul>
<p>But this is just a demo of the possibilities of Yoke and Vert.x.</p></div>
                  </div>
          </div>

    <hr/>

    <footer>
            <div class="container">
                      <div class="row">
                              <p >Copyright &copy;                   2015.
          All rights reserved.      
                    
      </p>
        </div>

        
                <p id="poweredBy" class="pull-right">
                          <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
              </p>
        
                </div>
    </footer>
        </body>
</html>
